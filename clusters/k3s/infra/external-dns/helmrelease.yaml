apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: external-dns
  namespace: external-dns
spec:
  interval: 5m
  install:
    createNamespace: true
  chart:
    spec:
      chart: external-dns
      # zur Not Version weglassen, wenn diese nicht existiert
      version: "1.15.0"
      sourceRef:
        kind: HelmRepository
        name: external-dns
        namespace: flux-system
  values:
  provider: google
  # 1) Projekt sicher setzen
  extraArgs:
    - --google-project=timebertt-dhbw

  # 2) Secret korrekt mounten + Keyname explizit
  google:
    serviceAccountSecret: google-clouddns
    serviceAccountSecretKey: service-account.json

  # 3) Falls das Chart die ADC-Env nicht selbst setzt, mounten wir hart:
  extraVolumes:
    - name: gcloud
      secret:
        secretName: google-clouddns
  extraVolumeMounts:
    - name: gcloud
      mountPath: /var/secrets/google
      readOnly: true
  env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /var/secrets/google/service-account.json

  # Deine Vorgaben
  domainFilters:
    - "dski23a.timebertt.dev"
  txtOwnerId: "student-sepf"
  sources:
    - ingress
    - service
